# 同步互斥(lec 18) spoc 思考题


- 有"spoc"标记的题是要求拿清华学分的同学要在实体课上完成，并按时提交到学生对应的ucore_code和os_exercises的git repo上。

## 个人思考题

### 基本理解
 - 什么是信号量？它与软件同步方法的区别在什么地方？
 - 什么是自旋锁？它为什么无法按先来先服务方式使用资源？
 - 下面是一种P操作的实现伪码。它能按FIFO顺序进行信号量申请吗？
```
 while (s.count == 0) {  //没有可用资源时，进入挂起状态；
        调用进程进入等待队列s.queue;
        阻塞调用进程;
}
s.count--;              //有可用资源，占用该资源； 
```

> 参考回答： 它的问题是，不能按FIFO进行信号量申请。
> 它的一种出错的情况
```
一个线程A调用P原语时，由于线程B正在使用该信号量而进入阻塞状态；注意，这时value的值为0。
线程B放弃信号量的使用，线程A被唤醒而进入就绪状态，但没有立即进入运行状态；注意，这里value为1。
在线程A处于就绪状态时，处理机正在执行线程C的代码；线程C这时也正好调用P原语访问同一个信号量，并得到使用权。注意，这时value又变回0。
线程A进入运行状态后，重新检查value的值，条件不成立，又一次进入阻塞状态。
至此，线程C比线程A后调用P原语，但线程C比线程A先得到信号量。
```

### 信号量使用

 - 什么是条件同步？如何使用信号量来实现条件同步？
 - 什么是生产者-消费者问题？
 - 为什么在生产者-消费者问题中先申请互斥信息量会导致死锁？

### 管程

 - 管程的组成包括哪几部分？入口队列和条件变量等待队列的作用是什么？
 - 为什么用管程实现的生产者-消费者问题中，可以在进入管程后才判断缓冲区的状态？
 - 请描述管程条件变量的两种释放处理方式的区别是什么？条件判断中while和if是如何影响释放处理中的顺序的？

### 哲学家就餐问题

 - 哲学家就餐问题的方案2和方案3的性能有什么区别？可以进一步提高效率吗？

### 读者-写者问题

 - 在读者-写者问题的读者优先和写者优先在行为上有什么不同？
 - 在读者-写者问题的读者优先实现中优先于读者到达的写者在什么地方等待？
 
## 小组思考题

1. （spoc） 每人用python threading机制用信号量和条件变量两种手段分别实现[47个同步问题](07-2-spoc-pv-problems.md)中的一题。向勇老师的班级从前往后，陈渝老师的班级从后往前。请先理解[]python threading
2. 

招聘问题 现有100名毕业生去甲、乙两公司求职，两公司合用一间接待室，其中甲公司招 收10 人，乙公司准备招收10人，招完为止。两公司各有一位人事主管在接待毕业生， 每位人事主管每次只可接待一人，其他毕业生在接待室外排成一个队伍等待。试用信 号量和P 、v 操作实现人员招聘过程。

由于毕业生仅排成一队，故用如图的一个队列数据结构表示。在队列中不含甲、乙公司.

A   B   A   A   B   Sm
A   B   Sn
B   A   ...          

都接待过的毕业生和己被录用的毕业生。只含标识为A （被甲接待过）或只含标识为B （被乙接待过）及无标识的毕业生队列。此外，sm 和Sn 分别为队列中甲、乙正在面试的毕业生i ( i = 1 , 2 ，…，100 ）标识、即此刻另一方不得面试该毕业生i 。K1和K2 为甲、乙所录取的毕业生数，C1 、C2 为互斥信号量。注意，如果甲录取了一人，且该生没有被乙面试的话，则乙面试的毕业生将减1 。办法是：如果甲录取了一人，且该生没有被乙面试可把乙的面试计数器C2加1 （相当于乙己面试了他），从而，保证乙面试的人数值为100 。反之对甲亦然。

var Sa,Sb,mutex:semaphore;
Sa:=Sb:=mnutex:=1;
C1,C2,K1,K2：integer;
C1:=C2:=K1:=K2:=0;
cobegin
    process 甲公司
        begin
        L1: P(mutex);
        P(Sa);
        C1:==C1+1 ;
        V(Sa);
        If C1≤100 then
        ｛
            从标识为B 且不为Sn 或
            无标识的毕业生队列中选
            第i 个学生，将学生i 标
            识为A 和Sm
        ｝
        V(mutex) ;
        面试；
        P(mutex);
        if 合格then
        {
            K1:=K1+1;
            if 学生i 的标识不含B then
            {
                P (Sb);
                C2:=C2+1;
                V(Sb);
                将学生i 从队列摘除；
            }
            else 将学生i 从队列摘除；
        }
        else if 学生i 的标识含B then
                将学生i 从队列摘除;
            else
                取消学生i 的Sm 标识；
        V(mutex);
        If(K1<10)&(C2<100) then
            goto L1;
end

process 乙公司
begin
    L2:P(mutex);
    P(Sb);
    C2:=C2+1;
    V(Sb);
    if C2≤100 then
        从标识为A 且不为sm 或无标识的
        毕业生队列中选第i个学生将学生i
        标识为B和Sn
    V(mutex);
    面试；
    P(mutex);
    if 合格then
    {
        K2:=K2+1;
        if 学生i 的标识不含A then
        {
        P(Sa)
        C1:=C1+1;
        V(Sa);
        将学生i 从队列摘除；
        }
        else 将学生i 从队列摘除；
    }
    else if 学生i 的标识含A then
            将学生i 从队列摘除；
        else
            取消学生i 的Sn 标识；
    V(mutex);
    if(K2<10)&(c1<100）then
        goto L2;
end
coend


3. 机制的介绍和实例](https://github.com/chyyuu/ucore_lab/tree/master/related_info/lab7/semaphore_condition)
